# Transformer (ç¼–ç å™¨-è§£ç å™¨) æœºå™¨ç¿»è¯‘æ¨¡å‹

æœ¬é¡¹ç›®å®ç°äº†ä¸€ä¸ª**ä»é›¶å¼€å§‹**ï¼ˆä½¿ç”¨PyTorchï¼‰æ„å»ºçš„Transformerï¼ˆç¼–ç å™¨-è§£ç å™¨ï¼‰æ¨¡å‹ï¼Œç”¨äºè‹±-æ³•ç¿»è¯‘ä»»åŠ¡ï¼ŒåŸºäºè½»é‡çº§çš„`opus_books`æ•°æ®é›†ã€‚

## åŠŸèƒ½ç‰¹ç‚¹
- çº¯PyTorchå®ç°ï¼šå¤šå¤´æ³¨æ„åŠ›æœºåˆ¶ã€å‰é¦ˆç¥ç»ç½‘ç»œã€æ®‹å·®è¿æ¥+å±‚å½’ä¸€åŒ–ã€æ­£å¼¦ä½ç½®ç¼–ç 
- ç¼–ç å™¨-è§£ç å™¨æ¶æ„ï¼ŒåŒ…å«æ©ç æœºåˆ¶ï¼ˆå¡«å……æ©ç +åç»­æ©ç ï¼‰
- ç®€å•çš„ç©ºæ ¼åˆ†è¯å™¨+åŠ¨æ€æ„å»ºè¯æ±‡è¡¨ï¼ˆå¯é…ç½®å¤§å°ï¼‰
- è®­ç»ƒå¾ªç¯ï¼šAdamä¼˜åŒ–å™¨ã€æ¢¯åº¦è£å‰ªã€ä½™å¼¦å­¦ä¹ ç‡è°ƒåº¦
- æ£€æŸ¥ç‚¹ä¿å­˜/åŠ è½½ã€æŸå¤±æ›²çº¿ç»˜åˆ¶ã€è§£ç è¿›è¡Œå®šæ€§ç¤ºä¾‹åˆ†æ
- å®Œæ•´çš„æ¶ˆèå®éªŒæ”¯æŒï¼Œå¯æµ‹è¯•ä¸åŒTransformerç»„ä»¶çš„è´¡çŒ®
- å¯å¤ç°çš„éšæœºç§å­+æ¸…æ™°çš„å‘½ä»¤è¡Œæ¥å£

## ç¯å¢ƒé…ç½®ä¸ä¾èµ–å®‰è£…

### ç³»ç»Ÿè¦æ±‚
- **æ“ä½œç³»ç»Ÿ**ï¼šLinuxã€macOSæˆ–Windows
- **Pythonç‰ˆæœ¬**ï¼š3.10æˆ–æ›´é«˜
- **ç¡¬ä»¶è¦æ±‚**ï¼š
  - **CPUæ¨¡å¼**ï¼šè‡³å°‘8GB RAMï¼Œè®­ç»ƒé€Ÿåº¦è¾ƒæ…¢
  - **GPUæ¨¡å¼**ï¼ˆæ¨èï¼‰ï¼šæ”¯æŒCUDAçš„NVIDIA GPUï¼Œè‡³å°‘8GB GPUå†…å­˜ï¼Œè®­ç»ƒé€Ÿåº¦æ˜¾è‘—æå‡

### å®‰è£…æ­¥éª¤

```bash
# 1) åˆ›å»ºå¹¶æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
conda create -n transformer python=3.10 -y
conda activate transformer

# 2) å®‰è£…ä¾èµ–
pip install -r requirements.txt
```

### ä¾èµ–åº“è¯´æ˜

ä»¥ä¸‹æ˜¯é¡¹ç›®ä½¿ç”¨çš„ä¸»è¦ä¾èµ–åº“åŠå…¶ç‰ˆæœ¬ï¼š

```
torch==2.2.2            # PyTorchæ·±åº¦å­¦ä¹ æ¡†æ¶
torchaudio==2.2.2       # PyTorchéŸ³é¢‘å¤„ç†åº“
torchvision==0.17.2     # PyTorchè®¡ç®—æœºè§†è§‰åº“
datasets==4.4.1         # Hugging Faceæ•°æ®é›†åŠ è½½åº“
matplotlib>=3.7         # ç»˜å›¾åº“ï¼Œç”¨äºæŸå¤±æ›²çº¿ç»˜åˆ¶
tqdm==4.67.1            # è¿›åº¦æ¡æ˜¾ç¤º
nltk>=3.8.1             # è‡ªç„¶è¯­è¨€å¤„ç†å·¥å…·åŒ…ï¼Œç”¨äºBLEUè¯„åˆ†
numpy>=1.24             # æ•°å€¼è®¡ç®—åº“
pandas>=2.0             # æ•°æ®å¤„ç†åº“
transformers>=4.35      # Hugging Face Transformeråº“ï¼ˆç”¨äºæ•°æ®é›†åŠ è½½ï¼‰
scikit-learn>=1.3       # æœºå™¨å­¦ä¹ å·¥å…·åº“
PyYAML>=6.0             # YAMLé…ç½®æ–‡ä»¶å¤„ç†
```

## æ•°æ®

æˆ‘ä»¬ä½¿ç”¨Hugging Faceçš„`datasets`åº“åŠ è½½`opus_books`è‹±-æ³•ç¿»è¯‘æ•°æ®é›†ï¼Œhttps://huggingface.co/datasets/Helsinki-NLP/opus_booksï¼Œæ•°æ®é›†å·²ä¿å­˜åœ¨dataæ–‡ä»¶å¤¹ä¸‹ã€‚

```python
from datasets import load_dataset
dataset = load_dataset("opus_books", "en-fr")
```

æ•°æ®é›†æ ¼å¼ç¤ºä¾‹ï¼š`{'id': '0', 'translation': {'en': 'The Wanderer', 'fr': 'Le grand Meaulnes'}}`

## è®­ç»ƒæŒ‡ä»¤

### 1. åˆå§‹å®éªŒï¼ˆæ ‡å‡†æ¨¡å‹ï¼‰

ä½¿ç”¨è„šæœ¬è¿è¡Œï¼ˆæ¨èï¼‰ï¼š
```bash
bash scripts/run.sh
```

æˆ–æ‰‹åŠ¨è¿è¡Œï¼š
```bash
python -m src.train \
  --epochs 8 \
  --batch_size 64 \
  --lr 3e-4 \
  --d_model 256 \
  --nhead 4 \
  --num_encoder_layers 3 \
  --num_decoder_layers 3 \
  --dim_feedforward 512 \
  --max_vocab 20000 \
  --max_len 128 \
  --seed 42 \
  --save_dir results
```

### 2. å¯¹æ¯”å®éªŒï¼ˆä¸åŒå¤´æ•°ï¼‰

ä½¿ç”¨4å¤´æ³¨æ„åŠ›ï¼š
```bash
python -m src.train_ablation \
  --nhead 4 \
  --experiment_name 4_heads \
  --seed 42
```

ä½¿ç”¨8å¤´æ³¨æ„åŠ›ï¼š
```bash
python -m src.train_ablation \
  --nhead 8 \
  --experiment_name 8_heads \
  --seed 42
```

ä½¿ç”¨å•å¤´æ³¨æ„åŠ›ï¼š
```bash
python -m src.train_ablation \
  --nhead 1 \
  --experiment_name single_head \
  --seed 42
```

### 3. æ¶ˆèå®éªŒ

ç¦ç”¨å¤šå¤´æ³¨æ„åŠ›ï¼ˆä½¿ç”¨å•å¤´ï¼‰ï¼š
```bash
python -m src.train_ablation \
  --no_multihead \
  --experiment_name no_multihead \
  --seed 42
```

ç¦ç”¨ä½ç½®ç¼–ç ï¼š
```bash
python -m src.train_ablation \
  --no_positional_encoding \
  --experiment_name no_positional_encoding \
  --seed 42
```

ç¦ç”¨æ®‹å·®è¿æ¥ï¼š
```bash
python -m src.train_ablation \
  --no_residual \
  --experiment_name no_residual \
  --seed 42
```

ç¦ç”¨å±‚å½’ä¸€åŒ–ï¼š
```bash
python -m src.train_ablation \
  --no_layernorm \
  --experiment_name no_layernorm \
  --seed 42
```

## é¡¹ç›®ç»“æ„

```
transformer_enfr/                 # é¡¹ç›®æ ¹ç›®å½•
â”œâ”€â”€ 4head.ipynb                  # 4å¤´æ³¨æ„åŠ›æ¨¡å‹å®éªŒ
â”œâ”€â”€ 8head.ipynb                  # 8å¤´æ³¨æ„åŠ›æ¨¡å‹å®éªŒ
â”œâ”€â”€ evn-pip.ipynb                # ç¯å¢ƒé…ç½®å’Œä¾èµ–å®‰è£…
â”œâ”€â”€ nomultihead.ipynb            # æ— å¤šå¤´æ³¨æ„åŠ›æ¨¡å‹å®éªŒ
â”œâ”€â”€ xiaorongshiyan.ipynb         # æ¶ˆèå®éªŒç»¼åˆåˆ†æ
â”œâ”€â”€ src/                         # æºä»£ç ç›®å½•
â”‚   â”œâ”€â”€ __init__.py              # PythonåŒ…åˆå§‹åŒ–æ–‡ä»¶
â”‚   â”œâ”€â”€ dataset.py               # æ•°æ®é›†å¤„ç†æ¨¡å—
â”‚   â”œâ”€â”€ model.py                 # æ ‡å‡†Transformeræ¨¡å‹å®šä¹‰
â”‚   â”œâ”€â”€ model_ablation.py        # æ”¯æŒæ¶ˆèå®éªŒçš„Transformeræ¨¡å‹
â”‚   â”œâ”€â”€ train.py                 # æ ‡å‡†è®­ç»ƒè„šæœ¬
â”‚   â”œâ”€â”€ train_ablation.py        # æ”¯æŒæ¶ˆèå®éªŒçš„è®­ç»ƒè„šæœ¬
â”‚   â”œâ”€â”€ utils.py                 # å·¥å…·å‡½æ•°ï¼ˆä½ç½®ç¼–ç ã€æ©ç ç”Ÿæˆç­‰ï¼‰
â”‚   â”œâ”€â”€ experiment_tracker.py    # å®éªŒè·Ÿè¸ªå·¥å…·
â”‚   â”œâ”€â”€ generate_missing_plots.py # ç”Ÿæˆç¼ºå¤±çš„å›¾è¡¨
â”‚   â””â”€â”€ visualization_tools.py   # å¯è§†åŒ–å·¥å…·
â”œâ”€â”€ data/                        # æ•°æ®å­˜å‚¨ç›®å½•
â”‚   â”œâ”€â”€ dataset_dict.json        # æ•°æ®é›†å­—å…¸ä¿¡æ¯
â”‚   â””â”€â”€ train/                   # è®­ç»ƒæ•°æ®
â”œâ”€â”€ results/                     # æ ‡å‡†å®éªŒç»“æœç›®å½•
â”‚   â”œâ”€â”€ loss_curve.png           # æŸå¤±æ›²çº¿å›¾
â”‚   â”œâ”€â”€ samples.txt              # ç¿»è¯‘æ ·ä¾‹
â”‚   â””â”€â”€ checkpoint.pt            # æ¨¡å‹æ£€æŸ¥ç‚¹
â”œâ”€â”€ results_ablation/            # æ¶ˆèå®éªŒç»“æœç›®å½•
â”‚   â”œâ”€â”€ [experiment_name]_[timestamp]/ # å„æ¶ˆèå®éªŒå­ç›®å½•
â”œâ”€â”€ scripts/                     # è„šæœ¬ç›®å½•
â”‚   â””â”€â”€ run.sh                   # è¿è¡Œè„šæœ¬
â”œâ”€â”€ requirements.txt             # é¡¹ç›®ä¾èµ–
â””â”€â”€ README.md                    # é¡¹ç›®è¯´æ˜æ–‡æ¡£
```

## æ–‡ä»¶åŠŸèƒ½è¯´æ˜

### Jupyterç¬”è®°æœ¬æ–‡ä»¶

- **4head.ipynb**ï¼šç”¨äº4å¤´æ³¨æ„åŠ›æ¨¡å‹çš„å®éªŒè®­ç»ƒåˆ†æ
- **8head.ipynb**ï¼šç”¨äº8å¤´æ³¨æ„åŠ›æ¨¡å‹çš„å®éªŒè®­ç»ƒåˆ†æ
- **evn-pip.ipynb**ï¼šç¯å¢ƒé…ç½®å’Œä¾èµ–å®‰è£…ä¸æ‰§è¡Œè„šæœ¬
- **nomultihead.ipynb**ï¼šæ— å¤šå¤´æ³¨æ„åŠ›æ¨¡å‹çš„è®­ç»ƒ
- **xiaorongshiyan.ipynb**ï¼šæ¶ˆèå®éªŒè®­ç»ƒ

### æ ¸å¿ƒæ¨¡å—æ–‡ä»¶

- **src/dataset.py**ï¼šå¤„ç†è‹±-æ³•ç¿»è¯‘æ•°æ®é›†ï¼ŒåŒ…æ‹¬æ•°æ®åŠ è½½ã€é¢„å¤„ç†ã€åˆ†è¯å’Œæ‰¹å¤„ç†
- **src/model.py**ï¼šå®ç°æ ‡å‡†Transformerç¼–ç å™¨-è§£ç å™¨æ¨¡å‹ï¼ŒåŒ…å«å¤šå¤´æ³¨æ„åŠ›ã€å‰é¦ˆç½‘ç»œç­‰æ ¸å¿ƒç»„ä»¶
- **src/model_ablation.py**ï¼šæ”¯æŒæ¶ˆèå®éªŒçš„Transformeræ¨¡å‹ï¼Œå¯ä»¥ç¦ç”¨ç‰¹å®šç»„ä»¶ï¼ˆå¤šå¤´æ³¨æ„åŠ›ã€ä½ç½®ç¼–ç ç­‰ï¼‰
- **src/train.py**ï¼šæ ‡å‡†è®­ç»ƒæµç¨‹ï¼ŒåŒ…æ‹¬æ¨¡å‹è®­ç»ƒã€éªŒè¯ã€è¯„ä¼°å’Œç»“æœä¿å­˜
- **src/train_ablation.py**ï¼šæ”¯æŒæ¶ˆèå®éªŒçš„è®­ç»ƒæµç¨‹ï¼Œå¯é…ç½®ä¸åŒå®éªŒå‚æ•°
- **src/utils.py**ï¼šæä¾›å„ç§å·¥å…·å‡½æ•°ï¼Œå¦‚ä½ç½®ç¼–ç ç”Ÿæˆã€æ©ç åˆ›å»ºã€éšæœºç§å­è®¾ç½®ç­‰

### ç»“æœè¾“å‡ºæ–‡ä»¶

#### æ ‡å‡†å®éªŒç»“æœï¼ˆresults/ç›®å½•ï¼‰
- **loss_curve.png**ï¼šè®­ç»ƒå’ŒéªŒè¯æŸå¤±æ›²çº¿å›¾
- **samples.txt**ï¼šæ¨¡å‹ç”Ÿæˆçš„ç¿»è¯‘æ ·ä¾‹
- **checkpoint.pt**ï¼šä¿å­˜çš„æ¨¡å‹æƒé‡ã€è¯æ±‡è¡¨å’Œè®­ç»ƒå‚æ•°

#### æ¶ˆèå®éªŒç»“æœï¼ˆresults_ablation/[experiment_name]_[timestamp]/ç›®å½•ï¼‰
- **best_model.pt**ï¼šéªŒè¯é›†ä¸Šè¡¨ç°æœ€å¥½çš„æ¨¡å‹
- **config.txt**ï¼šå®éªŒé…ç½®å‚æ•°è®°å½•
- **loss_curve.png**ï¼šæŸå¤±æ›²çº¿å›¾
- **metrics.npz**ï¼šè¯„ä¼°æŒ‡æ ‡æ•°æ®
- **samples.txt**ï¼šç¿»è¯‘æ ·ä¾‹
- **test_results.txt**ï¼šæµ‹è¯•é›†è¯„ä¼°ç»“æœ

## å¤ç°è¯´æ˜

ä¸ºç¡®ä¿å®éªŒç»“æœå¯å¤ç°ï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹è®¾ç½®ï¼š

1. **éšæœºç§å­**ï¼šæ‰€æœ‰å®éªŒä½¿ç”¨ç»Ÿä¸€çš„éšæœºç§å­`--seed 42`
2. **ç¯å¢ƒä¸€è‡´æ€§**ï¼šç¡®ä¿ä½¿ç”¨requirements.txtä¸­æŒ‡å®šçš„åº“ç‰ˆæœ¬
3. **è®­ç»ƒå‚æ•°**ï¼šä½¿ç”¨ä¸Šè¿°æŒ‡ä»¤ä¸­çš„å‚æ•°è¿›è¡Œè®­ç»ƒ
4. **ç¡¬ä»¶å½±å“**ï¼šåœ¨ä¸åŒç¡¬ä»¶ä¸Šå¯èƒ½ç•¥æœ‰å·®å¼‚ï¼Œä½†æ€»ä½“è¶‹åŠ¿åº”ä¸€è‡´

## è®­ç»ƒæ—¶é—´ä¼°è®¡

- **GPUæ¨¡å¼**ï¼ˆæ¨èï¼‰ï¼šä½¿ç”¨é»˜è®¤å‚æ•°ï¼ˆbatch_size=64ï¼Œ3å±‚ç¼–ç å™¨/è§£ç å™¨ï¼‰ï¼Œå®Œæ•´è®­ç»ƒçº¦éœ€è¦1-2å°æ—¶
- **CPUæ¨¡å¼**ï¼šç›¸åŒé…ç½®å¯èƒ½éœ€è¦10-20å°æ—¶ï¼Œå»ºè®®ä½¿ç”¨æ›´å°çš„batch_sizeï¼ˆå¦‚16æˆ–32ï¼‰

## æ³¨æ„äº‹é¡¹

- æœ¬é¡¹ç›®**ä¸ä½¿ç”¨**Hugging Faceçš„`transformers`åº“ä¸­çš„é¢„æ„å»ºæ¨¡å‹ï¼Œæ‰€æœ‰æ ¸å¿ƒæ¨¡å—ä»0æ­å»º
- åˆ†è¯å™¨åŸºäºç®€å•çš„ç©ºæ ¼åˆ†è¯ï¼Œä¸ºäº†ç®€åŒ–å®ç°ã€‚
- åœ¨èµ„æºå—é™çš„ç¯å¢ƒä¸­ï¼Œå¯ä»¥é€šè¿‡å‡å°batch_sizeã€æ¨¡å‹ç»´åº¦ï¼ˆd_modelï¼‰æˆ–å±‚æ•°æ¥é™ä½å†…å­˜å ç”¨
## æ¨¡å‹ä¸‹è½½ä¸å®Œæ•´ç‰ˆæœ¬

ç”±äº GitHub å¯¹å•ä¸ªæ–‡ä»¶å¤§å°ï¼ˆ100 MBï¼‰æœ‰é™åˆ¶ï¼Œæœ¬ä»“åº“ä¸­æœªåŒ…å«è®­ç»ƒå¥½çš„æ¨¡å‹æƒé‡æ–‡ä»¶ï¼ˆ`.pt`ï¼‰ã€‚

å¯ä»¥é€šè¿‡ä»¥ä¸‹é“¾æ¥ä¸‹è½½å®Œæ•´ç‰ˆæœ¬ï¼ˆåŒ…å«æ‰€æœ‰å®éªŒçš„æƒé‡æ–‡ä»¶ã€ç»“æœä¸æ—¥å¿—ï¼‰ï¼š

ğŸ”— **ç™¾åº¦ç½‘ç›˜ä¸‹è½½é“¾æ¥**  
ğŸ“¦ ä¸‹è½½åœ°å€ï¼š[å®Œæ•´æ–‡ä»¶ä¸‹è½½](https://pan.baidu.com/s/1tWEDOTpqWd0XNtFluZQwbA?pwd=yxv9 )
ğŸ”‘ æå–ç ï¼š`yxv9`


